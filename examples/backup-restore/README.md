# Example backup and restore Crossplane use cases


# Setup

## Deploy EKS Clusters

### Deploy Source Cluster on us-west-2 region with EKS 1.25
```shell
cd destination
```
```shell
terraform init
terraform plan
terraform apply -auto-approve
```


Setup Source terminal
```shell
export KUBECONFIG=~/eks-source
aws eks update-kubeconfig --name crossplane-source --alias crossplane-source --region us-west-2 --kubeconfig ${KUBECONFIG}
```

### Deploy Destination Cluster on us-east-1 region with EKS 1.26
```shell
cd destination
```
```shell
terraform init
terraform plan
terraform apply -auto-approve
```

Setup Destination terminal
```shell
export KUBECONFIG=~/eks-destination
aws eks update-kubeconfig --name crossplane-destination --alias crossplane-destination --region us-east-1 --kubeconfig ${KUBECONFIG}
```


Deploy s3 bucket using argocd on source cluster
```shell
kubectl apply -f ../argocd/argocd-app-s3.yaml
```

Open ArgoCD UI
#### Step9: Access the ArgoCD UI
Get the load balancer url:
```shell
kubectl -n argocd get service argo-cd-argocd-server -o jsonpath="{.status.loadBalancer.ingress[*].hostname}{'\n'}"
```
Copy and paste the result in your browser.<br>
The initial username is `admin`. The password is autogenerated and you can get it by running the following command:
```shell
echo "$(kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d)"
```

### Backup on the Source cluster
```shell
velero backup create gitops-control-planes --exclude-namespaces default,velero,kube-node-lease,kube-public,kube-system --exclude pods
```

Notes:
```shell
velero backup create xp-backup-manual-crds2 --include-cluster-scoped-resources '*.crossplane.io' --include-namespaces crossplane-system --exclude-namespace-scoped-resources pods
```

backup only s3 bucket
```shell
velero backup create crossplane-mrs --include-cluster-scoped-resources buckets.s3.aws.upbound.io --exclude-namespaces default,velero,kube-node-lease,kube-public,kube-system,argocd,crossplane-system
```


Simulate failure on source cluster
```shell

```

### Restore on the Destination cluster
Check backup is available
```shell
velero backup describe gitops-control-planes
```
Start restore of backup
```shell
velero restore create --from-backup gitops-control-planes
```

Run the output command until Phase is Completed
```shell
velero restore describe gitops-control-planes-...
```
